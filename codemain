// //       // Add with other element references
// //       const audioCaptureBtn = document.querySelector('[id^="audioCaptureBtn"]');
// //       let isAudioCaptureActive = false;

// //       audioCaptureBtn?.addEventListener('click', async () => {
// //   if (!isAudioCaptureActive) {
// //     const mode = confirm('Auto-respond mode?\n\nOK = Continuous (every 3s, auto-send)\nCancel = Manual (record until stop, inject to browser)');
    
// //     const result = await window.audioCaptureSystem.startCapture({
// //       captureSystemAudio: false,
// //       captureMicrophone: true,
// //       interval: 3000,
// //       mode: mode ? 'continuous' : 'manual'
// //     });
    
// //     if (result.success) {
// //       isAudioCaptureActive = true;
// //       audioCaptureBtn.style.background = 'rgba(239, 68, 68, 0.8)';
// //       audioCaptureBtn.textContent = '‚èπÔ∏è';
// //       audioCaptureBtn.title = mode ? 'Stop continuous listening' : 'Stop and send to browser';
      
// //       if (mode) {
// //         showBrowserNotification('üéôÔ∏è Continuous: Listening  ...');
// //       } else {
// //         showBrowserNotification('üéôÔ∏è Manual: Recording... Click ‚èπÔ∏è to inject to browser');
// //       }
// //     } else {
// //       showBrowserNotification('‚ùå ' + result.error);
// //     }
// //   } else {
// //     window.audioCaptureSystem.stopCapture();
// //     isAudioCaptureActive = false;
// //     audioCaptureBtn.style.background = '';
// //     audioCaptureBtn.textContent = 'üéôÔ∏è';
// //     showBrowserNotification('‚èπÔ∏è Recording stopped & processing...');
// //   }
// // });
// // // Make sure this is ONLY defined ONCE in your code
// //       socket.on('transcription_result', async (data) => {
// //       console.log('üîî === TRANSCRIPTION EVENT RECEIVED ===');
// //       console.log('Raw data:', data);
// //       console.log('Data type:', typeof data);
      
// //       const { transcript, mode } = data;
      
// //       console.log(`üìù Transcription mode: ${mode}`);
// //       console.log(`üìù Transcript text: "${transcript}"`);
      
// //       if (!transcript || transcript === '<nospeech>' || transcript.length < 3) {
// //         console.log('‚ö†Ô∏è Transcript filtered out (empty/nospeech)');
// //         return;
// //       }
      
// //       const prompt = `Analyse the speech and tell the answer: ${transcript}`;
// //       console.log('üì§ Prompt created:', prompt);
      
// //       if (mode === 'manual') {
// //         console.log('üéØ MANUAL MODE');
        
// //         // Check browser state
// //         console.log('Browser active?', browserView.classList.contains('active'));
// //         console.log('Current browser provider:', currentBrowserProvider);
// //         console.log('Current provider:', currentProvider);
        
// //         if (browserView.classList.contains('active') && currentBrowserProvider) {
// //           console.log('‚úÖ Injecting to active browser:', currentBrowserProvider);
// //           await injectTextToBrowser(prompt, true);
// //           showBrowserNotification(`‚úÖ Sent to ${currentBrowserProvider}: "${transcript.substring(0, 30)}..."`);
// //         } else if (currentProvider === 'claude' || currentProvider === 'chatgpt') {
// //           console.log('üåê Opening browser for:', currentProvider);
// //           openBrowser(currentProvider);
// //           setTimeout(async () => {
// //             console.log('‚è±Ô∏è Browser should be loaded, injecting...');
// //             await injectTextToBrowser(prompt, true);
// //             showBrowserNotification(`‚úÖ Sent to ${currentProvider}: "${transcript.substring(0, 30)}..."`);
// //           }, 2000);
// //         } else {
// //           console.log('üìù Putting in message input');
// //           messageInput.value = prompt;
// //           messageInput.style.height = 'auto';
// //           messageInput.style.height = Math.min(messageInput.scrollHeight, 80) + 'px';
// //           showBrowserNotification(`üìù Speech captured: "${transcript.substring(0, 30)}..."`);
// //         }
// //       } else {
// //         console.log('üîÑ CONTINUOUS MODE');
        
// //         if (browserView.classList.contains('active') && currentBrowserProvider) {
// //           console.log('‚úÖ Injecting to active browser:', currentBrowserProvider);
// //           await injectTextToBrowser(prompt, true);
// //           showBrowserNotification(`ü§ñ Auto-sent to ${currentBrowserProvider}: "${transcript.substring(0, 30)}..."`);
// //         } else if (currentProvider.startsWith('gemini-')) {
// //           console.log('ü§ñ Sending to Gemini:', currentProvider);
// //           addMessage(prompt, true, [], null, currentProvider);
          
// //           showLoading();
// //           socket.emit('send_message', {
// //             prompt: prompt,
// //             images: [],
// //             provider: currentProvider
// //           });
          
// //           showBrowserNotification(`ü§ñ Auto-responding to: "${transcript.substring(0, 30)}..."`);
// //         } else {
// //           console.log('üìù Putting in message input (fallback)');
// //           messageInput.value = prompt;
// //           messageInput.style.height = 'auto';
// //           messageInput.style.height = Math.min(messageInput.scrollHeight, 80) + 'px';
// //         }
// //       }
      
// //       console.log('‚úÖ === TRANSCRIPTION HANDLER COMPLETE ===');
// //     });

  
// //  socket.on("transcribe_audio", async (data) => {
//     console.log('üé§ === TRANSCRIPTION REQUEST RECEIVED ===');
    
//     try {
//       const { buffer, mimeType, mode = 'continuous', sessionId } = data;
      
//       if (!buffer) {
//         throw new Error("No audio buffer received");
//       }

//       const audioBuffer = Buffer.from(buffer);
//       console.log(`üé§ Processing: ${audioBuffer.length} bytes, mode: ${mode}, session: ${sessionId}`);
      
//       // Transcribe
//       const transcript = await transcribeAudio(audioBuffer, mimeType);
//       console.log(`‚úÖ Got transcript: "${transcript}"`);
      
//       // Find the current socket for this session
//       let targetSocket = socket; // Default to current socket
      
//       if (sessionId) {
//         // Try to find socket by session ID
//         const session = await ChatSession.findById(sessionId);
//         if (session && chatbotSockets.has(session.socketId)) {
//           targetSocket = chatbotSockets.get(session.socketId);
//           console.log(`‚úÖ Found active socket for session: ${session.socketId}`);
//         } else {
//           console.log(`‚ö†Ô∏è Session socket not found, using current: ${socket.id}`);
//         }
//       }
      
//       // Filter and emit
//       if (mode === 'manual') {
//         if (transcript && transcript.trim()) {
//           console.log("üì§ Emitting manual transcription to:", targetSocket.id);
//           targetSocket.emit("transcription_result", { transcript, mode });
//         }
//       } else {
//         if (transcript && 
//             transcript.trim() && 
//             transcript !== '<nospeech>' &&
//             transcript.length > 3) {
//           console.log("üì§ Emitting auto transcription to:", targetSocket.id);
//           targetSocket.emit("transcription_result", { transcript, mode });
//         }
//       }
      
//     } catch (error) {
//       console.error("‚ùå Transcription error:", error.message);
//       if (data.mode === 'manual') {
//         socket.emit("transcription_error", error.message);
//       }
//     }
    
//     console.log('üé§ === TRANSCRIPTION REQUEST COMPLETE ===');
//   });
